<div class="contaider p-4">
    <div class="row">
        <div class="col-md-4 mx-auto">
            <div class="card">
                <div class="card-header text-center">
                    <h3>Edita Bloques</h3>
                </div>
                <div class="card-body">
                    <form action="/bloque/edit/{{bloque.id_bloque}}" method="post">
                        <div class="form-group">
                            <label for="">Nombre del Bloque</label>
                            <input type="text" value="{{bloque.nombre}}" class="form-control" id="nombre" name="nombre"
                                placeholder="Nombre Bloque" readonly>
                        </div>
                        <div class="form-group">
                            <label for="">Tipo de material</label>
                            <select class="form-control" name="tipo_material" placeholder="Tipo de material" autofocus>
                                <option value="3D" {{#if (eq bloque.tipo_material "3D" )}}selected{{/if}}>3D</option>
                                <option value="SAGEMAX" {{#if (eq bloque.tipo_material "SAGEMAX" )}}selected{{/if}}>SAGEMAX</option>
                                <option value="STC" {{#if (eq bloque.tipo_material "STC" )}}selected{{/if}}>STC</option>
                                <option value="SHTC" {{#if (eq bloque.tipo_material "SHTC" )}}selected{{/if}}>SHTC</option>
                                <option value="CR CB" {{#if (eq bloque.tipo_material "CR CB" )}}selected{{/if}}>CR CB</option>
                                <option value="TITAN" {{#if (eq bloque.tipo_material "TITAN" )}}selected{{/if}}>TITAN</option>
                                <option value="PMMA" {{#if (eq bloque.tipo_material "PMMA" )}}selected{{/if}}>PMMA</option>
                                <option value="SHOFU HC" {{#if (eq bloque.tipo_material "SHOFU HC" )}}selected{{/if}}>SHOFU HC</option>
                                <option value="PMMA ML" {{#if (eq bloque.tipo_material "PMMA ML" )}}selected{{/if}}>PMMA ML</option>
                                <option value="HTW OPACO" {{#if (eq bloque.tipo_material "HTW OPACO" )}}selected{{/if}}>HTW OPACO</option>
                                <option value="AIZIR" {{#if (eq bloque.tipo_material "AIZIR" )}}selected{{/if}}>AIZIR</option>
                                <option value="PEEK" {{#if (eq bloque.tipo_material "PEEK" )}}selected{{/if}}>PEEK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="">Factor de contracción</label>
                            <input type="text" value="{{bloque.factor_contraccion}}" class="form-control" id="factor_contraccion"
                                name="factor_contraccion" placeholder="Factor de contracción" readonly>
                        </div>
                        <div class="form-group">
                            <label for="">Codigo de Barras</label>
                            <input type="text" value="{{bloque.codigo_barras}}" class="form-control" id="codigo_barras"
                                name="codigo_barras" placeholder="Codigo de barras" readonly>
                        </div>
                        <div class="form-group">
                            <label for="">Lote</label>
                            <input type="text" value="{{bloque.cantidad}}" class="form-control" name="cantidad"
                                placeholder="Lote" readonly>
                        </div>
                        <div class="form-group">
                            <label for="">Color (VITA Clásica):</label>
                            <select class="form-control" id="color" name="color" placeholder="Color (VITA Clásica):"
                                autofocus>
                                <option value="A1" {{#if (eq bloque.color "A1" )}}selected{{/if}}>A1</option>
                                <option value="A2" {{#if (eq bloque.color "A2" )}}selected{{/if}}>A2</option>
                                <option value="A3" {{#if (eq bloque.color "A3" )}}selected{{/if}}>A3</option>
                                <option value="A3.5" {{#if (eq bloque.color "A3.5" )}}selected{{/if}}>A3.5</option>
                                <option value="A4" {{#if (eq bloque.color "A4" )}}selected{{/if}}>A4</option>
                                <option value="B1" {{#if (eq bloque.color "B1" )}}selected{{/if}}>B1</option>
                                <option value="B2" {{#if (eq bloque.color "B2" )}}selected{{/if}}>B2</option>
                                <option value="B3" {{#if (eq bloque.color "B3" )}}selected{{/if}}>B3</option>
                                <option value="B4" {{#if (eq bloque.color "B4" )}}selected{{/if}}>B4</option>
                                <option value="C1" {{#if (eq bloque.color "C1" )}}selected{{/if}}>C1</option>
                                <option value="C2" {{#if (eq bloque.color "C2" )}}selected{{/if}}>C2</option>
                                <option value="C3" {{#if (eq bloque.color "C3" )}}selected{{/if}}>C3</option>
                                <option value="C4" {{#if (eq bloque.color "C4" )}}selected{{/if}}>C4</option>
                                <option value="D2" {{#if (eq bloque.color "D2" )}}selected{{/if}}>D2</option>
                                <option value="D3" {{#if (eq bloque.color "D3" )}}selected{{/if}}>D3</option>
                                <option value="D4" {{#if (eq bloque.color "D4" )}}selected{{/if}}>D4</option>
                                <option value="0M1" {{#if (eq bloque.color "0M1" )}}selected{{/if}}>0M1</option>
                                <option value="0M2" {{#if (eq bloque.color "0M2" )}}selected{{/if}}>0M2</option>
                                <option value="0M3" {{#if (eq bloque.color "0M3" )}}selected{{/if}}>0M3</option>
                                <option value="BL1" {{#if (eq bloque.color "BL1" )}}selected{{/if}}>BL1</option>
                                <option value="BL2" {{#if (eq bloque.color "BL2" )}}selected{{/if}}>BL2</option>
                                <option value="BL3" {{#if (eq bloque.color "BL3" )}}selected{{/if}}>BL3</option>
                                <option value="BL4" {{#if (eq bloque.color "BL4" )}}selected{{/if}}>BL4</option>
                                <option value="WHITE" {{#if (eq bloque.color "WHITE" )}}selected{{/if}}>WHITE</option>
                                <option value="BLANCO OPACO" {{#if (eq bloque.color "BLANCO OPACO" )}}selected{{/if}}>BLANCO OPACO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="">Tamaño</label>
                            <select class="form-control" name="tamano" placeholder="Tamaño" autofocus>
                                <option value="8" {{#if (eq bloque.tamano 8)}}selected{{/if}}>8</option>
                                <option value="10" {{#if (eq bloque.tamano 10)}}selected{{/if}}>10</option>
                                <option value="12" {{#if (eq bloque.tamano 12)}}selected{{/if}}>12</option>
                                <option value="14" {{#if (eq bloque.tamano 14)}}selected{{/if}}>14</option>
                                <option value="16" {{#if (eq bloque.tamano 16)}}selected{{/if}}>16</option>
                                <option value="18" {{#if (eq bloque.tamano 18)}}selected{{/if}}>18</option>
                                <option value="20" {{#if (eq bloque.tamano 20)}}selected{{/if}}>20</option>
                                <option value="22" {{#if (eq bloque.tamano 22)}}selected{{/if}}>22</option>
                                <option value="25" {{#if (eq bloque.tamano 25)}}selected{{/if}}>25</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: none;">
                            <select name="id_operario" id="id_operario" class="form-control" required readonly>
                                <!-- Itera sobre el array de operarios -->
                                {{#each operarios}}
                                <option value="{{id_operario}}">{{fullname}} (ID: {{id_operario}})</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success btn-block">
                                Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Listas de frutas y colores aleatorios
    const frutas = [
        "MANZANA", "PLÁTANO", "PERA", "NARANJA", "UVA", "MELÓN", "SANDÍA", "FRESA", "PIÑA", "DURAZNO",
        "MANGO", "PAPAYA", "KIWI", "CEREZA", "CIRUELA", "GRANADA", "FRAMBUESA", "MORA", "MARACUYÁ", "LIMÓN",
        "MANDARINA", "AGUACATE", "LITCHI", "GUAYABA", "DURIAN", "PITAYA", "CARAMBOLA", "POMELO", "TAMARINDO",
        "MANGO DE AGUA", "CHIRIMOYA", "ZAPOTE", "COCO", "PASA", "ACELGA", "ALMENDRA", "CASTAÑA", "NÍSPERO",
        "SOURSOP", "RAMBUTÁN", "LANGSAT", "PITANGUEIRAS", "MAMEY", "BERRIES", "TAMARILLO", "LONGAN", "FEIJOA"
    ];

    const coloresAleatorios = [
        "ROJO", "AZUL", "VERDE", "AMARILLO", "NEGRO", "BLANCO", "ROSA", "MORADO", "NARANJA", "GRIS", "TURQUESA",
        "VIOLETA", "FUCSIA", "MARRÓN", "BEIGE", "CELESTE", "CORAL", "LAVANDA", "LILA", "AQUA", "ÍNDIGO", "ORO",
        "PLATA", "BRONCE", "VERDE OLIVA", "VERDE LIMA", "VERDE BOSQUE", "VERDE PASTO", "AZUL MARINO", "AZUL CLARO",
        "AZUL TURQUESA", "AMARILLO PASTEL", "NARANJA PASTEL", "ROSA PÁLIDO", "PÚRPURA", "MALVA", "MENTA", "BEIS",
        "CAFÉ", "ROJO VINO", "LAVANDA", "BLANCO NIEVE", "GRIS PERLA", "VERDE MUSGO", "AMARILLO MOSTAZA", "LIMA",
        "AZUL ELÉCTRICO", "AZUL ZAFIRO", "CHAMPAGNE", "TOPACIO", "CIAN", "SALMON", "CARAMELO", "ROSADO", "PISTACHO",
        "VERDE ESMERALDA", "VERDE MENTA", "NARANJA QUEMADO", "ROSA PALO", "FUCSIA BRILLANTE", "COBRE", "ROJO",
        "AMARILLO CANARIO", "MARFIL", "AZUL PETRÓLEO", "VINO TINTO", "TERRACOTA", "ROJO CARMESÍ", "VINO BORGOÑA",
        "COBALTO", "MAGENTA", "MALVA CLARO", "GARNET", "ÁMBAR", "ÁRTICO", "MAUVE", "TANGERINE", "FLUORESCENTE",
        "LIME GREEN", "TIERRA", "CIELITO", "MADERA", "PETROLERO", "CEREZA BRILLANTE", "SIENA QUEMADA", "ALMIZCLE"
    ];

    // Guardar los valores iniciales al cargar la página
    let valoresIniciales = {};

    // Función para guardar los valores iniciales
    function guardarValoresIniciales() {
        valoresIniciales.tipo_material = document.querySelector('[name="tipo_material"]').value;
        valoresIniciales.tamano = document.querySelector('[name="tamano"]').value;
        valoresIniciales.color = document.querySelector('[name="color"]').value;
    }

    // Función para manejar la visibilidad del campo color
    function manejarVisibilidadColor() {
        const tipoMaterial = document.querySelector('[name="tipo_material"]').value;
        const colorField = document.querySelector('[name="color"]').closest('.form-group');

        // Ocultar el campo color si el material es CR CB o TITAN
        if (tipoMaterial === "CR CB" || tipoMaterial === "TITAN") {
            colorField.style.display = 'none';
        } else {
            colorField.style.display = 'block';
        }
    }

    // Función para generar un nombre para el bloque al editar
    function generarNombreBloqueEditar() {
        // Obtener los valores actuales de la base de datos
        const tipo_material = document.querySelector('[name="tipo_material"]').value;
        const tamano = document.querySelector('[name="tamano"]').value;
        const color = document.querySelector('[name="color"]').value;
        const nombreActual = document.getElementById("nombre").value;

        // Obtener la fruta y color actual del nombre (para no cambiarlos cada vez)
        const partes = nombreActual.split("-");
        const frutaGuardada = partes[1] || frutas[Math.floor(Math.random() * frutas.length)];
        const colorGuardado = partes[2] || coloresAleatorios[Math.floor(Math.random() * coloresAleatorios.length)];

        // Generar el nuevo nombre con los valores actuales
        let nuevoNombre;
        if (tipo_material === 'TITAN' || tipo_material === 'CR CB') {
            nuevoNombre = `${tipo_material}-${frutaGuardada}-${colorGuardado}-H${tamano}`;
        } else {
            nuevoNombre = `${tipo_material}-${frutaGuardada}-${colorGuardado}-${color}-H${tamano}`;
        }

        document.getElementById("nombre").value = nuevoNombre;
    }

    // Llamar a la función cuando se cargue la página
    document.addEventListener("DOMContentLoaded", function () {
        guardarValoresIniciales();
        manejarVisibilidadColor();

        // Establecer eventos para actualizar el nombre cuando se cambian los campos
        const campos = document.querySelectorAll('[name="tipo_material"], [name="color"], [name="tamano"]');
        campos.forEach(campo => {
            campo.addEventListener("change", () => {
                manejarVisibilidadColor();  // Ocultar o mostrar el color según el tipo de material
                generarNombreBloqueEditar();  // Actualizar el nombre si se hacen cambios
            });
        });
    });

    // Manejar el envío del formulario para asignar null al color si es necesario
    const form = document.querySelector('form');
    form.addEventListener('submit', (e) => {
        const tipoMaterial = document.querySelector('[name="tipo_material"]').value;
        const colorField = document.querySelector('[name="color"]');

        if (tipoMaterial === 'TITAN' || tipoMaterial === 'CR CB') {
            colorField.value = '';  // Dejar vacío para que se guarde como NULL en la BD
        }
    });
</script>